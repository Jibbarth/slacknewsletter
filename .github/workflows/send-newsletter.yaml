name: Build and send newsletter
on:
    schedule:
        #- cron: '1 8 * * 1'
        - cron: '*/10 * * * *'

jobs:
    build-and-send:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout 🛎️
                uses: actions/checkout@v2
                with:
                    persist-credentials: false
            -   uses: shivammathur/setup-php@v1
                with:
                    php-version: 7.4
                    coverage: none
            -   name: Composer install 📦
                run: composer install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader --no-suggest
            -   name: Create Channels.json
                run: echo $CHANNELS > config/channels.json
                env:
                    CHANNELS: ${{ secrets.CHANNELS }}
            -   uses: actions/download-artifact@v2
                with:
                    name: messages
                    path: public/messages/current
                continue-on-error: true
            -   name: Build and Send
                run: php bin/console app:newsletter:build --ansi && php bin/console app:newsletter:send --ansi --no-archive
                env:
                    SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
                    MAILER_DSN: ${{ secrets.MAILER_DSN }}
                    RECEIVERS: ${{ secrets.RECEIVERS }}
            -   uses: actions/upload-artifact@v2
                with:
                    name: messages
                    path: public/messages/current/
            -   uses: actions/upload-artifact@v2
                with:
                    name: latest-nl
                    path: public/news/current/current.html
